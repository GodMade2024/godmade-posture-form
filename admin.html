<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê°“ë©”ì´ë“œ ë¬¸ì§„ ë°ì´í„° ê´€ë¦¬ì í˜ì´ì§€</title>

  <!-- ì¦ìƒ ê·¸ë˜í”„ìš© Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --accent: #22c55e;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --radius-xl: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
      background: #f3f4f6;
      color: var(--text-main);
      padding: 32px 16px;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1150px;
    }

    /* HEADER */
    .header {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .badge-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .logo-dot {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: conic-gradient(from 140deg, #22c55e, #2563eb, #a855f7, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 0.78rem;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0ebff;
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .title {
      font-size: 1.6rem;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    .header-right {
      text-align: right;
      font-size: 0.8rem;
      color: var(--text-sub);
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .header-right > div {
      text-align: right;
    }

    /* CARD */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 18px;
      border: 1px solid #e5e7eb;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    /* STATS */
    .stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stat-box {
      flex: 1;
      min-width: 180px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-extra {
      margin-top: 3px;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .muted {
      color: var(--text-sub);
      font-size: 0.8rem;
    }

    /* FILTERS & SEARCH */
    .filters-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
    }

    .search-box input,
    .filter-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.82rem;
      background: #ffffff;
    }

    .filter-label {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 140px;
    }

    .btn {
      padding: 7px 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(90deg, #2563eb, #22c55e);
      color: #ffffff;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.45);
    }

    .btn-outline {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 0.75rem;
      box-shadow: none;
    }

    /* LAYOUT grid */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.1fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* TABLE */
    .table-container {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    thead {
      background: #f1f5f9;
    }

    th, td {
      padding: 9px 8px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      white-space: nowrap;
    }

    th.sortable::after {
      content: "â‡…";
      font-size: 0.7rem;
      margin-left: 4px;
      color: #9ca3af;
    }

    tr:hover {
      background: #f9fafb;
    }

    td { vertical-align: top; }

    .pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.72rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin: 1px 3px 1px 0;
    }

    .pill-tag {
      background: #fef9c3;
      color: #92400e;
      border: 1px solid #facc15;
    }

    .tag-remove {
      margin-left: 4px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.8rem;
      color: #92400e;
    }

    /* PAGINATION */
    .pagination {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 6px 8px;
      border-top: 1px solid #e5e7eb;
    }

    .page-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .page-btn[disabled] {
      opacity: 0.5;
      cursor: default;
    }

    .page-info {
      font-size: 0.78rem;
      color: #4b5563;
    }

    /* GRAPH */
    .graph-card {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 10px 10px 8px;
      background: #f9fafb;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .graph-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .graph-subtitle {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .graph-wrapper {
      flex: 1;
      min-height: 220px;
    }

    .footer-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* DUPLICATE CARD */
    .dup-card table {
      border-radius: 0;
      border: none;
    }

    /* MODAL (DETAIL) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 18px;
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
      padding: 16px 18px 14px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 700;
    }

    .modal-meta {
      font-size: 0.78rem;
      color: var(--text-sub);
    }

    .modal-close {
      border: none;
      background: #e5e7eb;
      border-radius: 999px;
      width: 26px;
      height: 26px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .modal-section {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .modal-section-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .modal-row {
      margin-bottom: 2px;
    }

    .modal-label {
      color: #6b7280;
    }

    .modal-note {
      font-size: 0.76rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* LOGIN OVERLAY */
    .login-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .login-card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 20px 18px 18px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.5);
      border: 1px solid #e5e7eb;
    }

    .login-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .login-sub {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .login-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 0.84rem;
      margin-bottom: 10px;
    }

    .login-hint {
      font-size: 0.74rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .login-remember {
      font-size: 0.78rem;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 8px;
    }

    /* PASSWORD CHANGE MODAL */
    .pw-modal-card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 18px 18px 16px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.5);
      border: 1px solid #e5e7eb;
    }

    .pw-label {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .pw-input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 0.82rem;
      margin-bottom: 8px;
    }

    .pw-hint {
      font-size: 0.74rem;
      color: #9ca3af;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <!-- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
  <div class="login-backdrop" id="login-backdrop">
    <div class="login-card">
      <div class="badge-row" style="margin-bottom:6px;">
        <div class="logo-dot">GM</div>
        <div class="badge">ê°“ë©”ì´ë“œ Admin ë¡œê·¸ì¸</div>
      </div>
      <div class="login-title">ê´€ë¦¬ì ì „ìš© í˜ì´ì§€</div>
      <div class="login-sub">
        ë¬¸ì§„ ë°ì´í„°ëŠ” ë¯¼ê° ì •ë³´ì¼ ìˆ˜ ìˆì–´ìš”.<br />
        ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ëŒ€ì‹œë³´ë“œë¥¼ ì—´ì–´ì£¼ì„¸ìš”.
      </div>
      <input
        type="password"
        id="admin-password-input"
        class="login-input"
        placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      />
      <label class="login-remember">
        <input type="checkbox" id="remember-login" />
        ì´ ë¸Œë¼ìš°ì €ì—ì„œ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€
      </label>
      <button class="btn btn-primary" type="button" onclick="attemptLogin()" style="width:100%; justify-content:center;">
        ë¡œê·¸ì¸
      </button>
      <div class="login-hint">
        ìµœì´ˆ ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ëŠ” ì½”ë“œ ìƒë‹¨ <code>ADMIN_PASSWORD</code> ê°’ì…ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="pw-backdrop">
    <div class="pw-modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div class="login-title" style="font-size:1rem;">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</div>
        <button class="modal-close" type="button" onclick="closePwModal()">âœ•</button>
      </div>
      <div class="login-sub" style="margin-bottom:10px;">
        í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      </div>
      <div>
        <div class="pw-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</div>
        <input type="password" id="pw-current" class="pw-input" />
      </div>
      <div>
        <div class="pw-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</div>
        <input type="password" id="pw-new" class="pw-input" />
      </div>
      <div>
        <div class="pw-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</div>
        <input type="password" id="pw-confirm" class="pw-input" />
      </div>
      <button class="btn btn-primary" type="button" style="width:100%; justify-content:center; margin-top:4px;" onclick="changePassword()">
        ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
      </button>
      <div class="pw-hint">
        ì´ ë¸Œë¼ìš°ì €ì˜ localStorageì—ë§Œ ì €ì¥ë˜ë©°, ê¸°ë³¸ê°’ì€ ADMIN_PASSWORDì…ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- ê³ ê¸‰ ì˜µì…˜ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="settings-backdrop">
    <div class="pw-modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div class="login-title" style="font-size:1rem;">ê³ ê¸‰ ì˜µì…˜</div>
        <button class="modal-close" type="button" onclick="closeSettingsModal()">âœ•</button>
      </div>
      <div class="login-sub" style="margin-bottom:10px;">
        ì•„ë˜ ê¸°ëŠ¥ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ê±°ë‚˜, ë°ì´í„°ì— í° ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br />
        ê¼­ í•„ìš”í•  ë•Œë§Œ ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.
      </div>

      <div style="border-radius:12px; border:1px solid #fecaca; background:#fef2f2; padding:10px 10px 8px; margin-bottom:10px;">
        <div style="font-size:0.9rem; font-weight:600; color:#b91c1c; margin-bottom:4px;">
          âš  ì „ì²´ ë¬¸ì§„ ë°ì´í„° ì‚­ì œ
        </div>
        <div style="font-size:0.78rem; color:#7f1d1d; margin-bottom:6px;">
          ì´ ë¸Œë¼ìš°ì €ì˜ <strong>localStorageì— ì €ì¥ëœ ëª¨ë“  ë¬¸ì§„/ë™ì˜ì„œ ë°ì´í„°ê°€ ì‚­ì œ</strong>ë©ë‹ˆë‹¤.<br />
          GitHub PagesÂ·ë„ë©”ì¸ ê¸°ì¤€ìœ¼ë¡œ ì €ì¥ëœ ë°ì´í„°ë§Œ ì˜í–¥ì„ ë°›ìœ¼ë©°, ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <button class="btn btn-danger btn-sm" type="button" onclick="handleClearData()">
          ì „ì²´ ë°ì´í„° ì˜êµ¬ ì‚­ì œ
        </button>
      </div>

      <div class="pw-hint">
        â€» ì´ë¯¸ êµ¬ê¸€ ì‹œíŠ¸ ë“± ì™¸ë¶€ë¡œ ë™ê¸°í™”ëœ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div class="page">
    <!-- HEADER -->
    <header class="header">
      <div>
        <div class="badge-row">
          <div class="logo-dot">GM</div>
          <div class="badge">ê°“ë©”ì´ë“œ ìš´ë™êµì • Â· Admin Dashboard</div>
        </div>
        <div class="title">ğŸ“Š ë¬¸ì§„ ë°ì´í„° ê´€ë¦¬ì í˜ì´ì§€</div>
        <div class="subtitle">
          index.htmlì—ì„œ ì‘ì„±ëœ <strong>ë™ì˜ì„œ + ì´ˆê¸° ë¬¸ì§„</strong> ë°ì´í„°ë¥¼ í•œ ê³³ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
        </div>
      </div>
      <div class="header-right">
        <div>ë™ì¼ ë¸Œë¼ìš°ì € ê¸°ì¤€ <strong>localStorage</strong> ì €ì¥</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn btn-outline btn-sm" type="button" onclick="location.href='index.html'">
            íšŒì›ìš© ë¬¸ì§„ í˜ì´ì§€
          </button>
          <button class="btn btn-outline btn-sm" type="button" onclick="openPwModal()">
            ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
          </button>
        </div>
      </div>
    </header>

    <!-- STATS + FILTERS + GRAPH -->
    <section class="card">
      <div class="card-title">ğŸ“ˆ ì „ì²´ í†µê³„ & í•„í„°</div>
      <div class="card-subtitle">
        index.htmlì—ì„œ ìˆ˜ì§‘ëœ ë¬¸ì§„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ìš”ì•½ í†µê³„, ê²€ìƒ‰, í•„í„°, ì •ë ¬ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>

      <!-- í†µê³„ -->
      <div class="stats" id="stats-row">
        <div class="stat-box">
          <div class="stat-label">ì´ ë¬¸ì§„ ê°œìˆ˜</div>
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-extra" id="stat-last">ìµœê·¼ ì‘ì„±: -</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">í‰ê·  í†µì¦ ê°•ë„ (0~10)</div>
          <div class="stat-value" id="stat-pain">0.0</div>
          <div class="stat-extra" id="stat-pain-extra">ë°ì´í„° ì—†ìŒ</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ê°€ì¥ ë§ì€ ë‚´ì› ëª©ì </div>
          <div class="stat-value" id="stat-purpose">-</div>
          <div class="stat-extra" id="stat-purpose-extra"></div>
        </div>
      </div>

      <!-- í•„í„°/ê²€ìƒ‰ -->
      <div class="filters-row" style="margin-top: 12px;">
        <div class="search-box">
          <div class="filter-label">ê²€ìƒ‰ (ì´ë¦„, ì—°ë½ì²˜, í†µì¦ë¶€ìœ„, íƒœê·¸ ë“±)</div>
          <input id="search-input" type="text" placeholder="ì˜ˆ: í—ˆë¦¬, í™ê¸¸ë™, 010, ì¬ë“±ë¡ìœ ë ¥ ë“±" />
        </div>

        <div class="filter-group">
          <div class="filter-label">ì‹œì‘ì¼</div>
          <input id="date-from" class="filter-input" type="date" />
        </div>

        <div class="filter-group">
          <div class="filter-label">ì¢…ë£Œì¼</div>
          <input id="date-to" class="filter-input" type="date" />
        </div>

        <div class="filter-group" style="min-width: 150px;">
          <div class="filter-label">ë¹ ë¥¸ ì•¡ì…˜</div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn btn-outline btn-sm" type="button" onclick="resetFilters()">í•„í„° ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <!-- ê·¸ë˜í”„ + í…Œì´ë¸” -->
      <div class="grid">
        <!-- í…Œì´ë¸” -->
        <div class="table-container">
          <table id="data-table">
            <thead>
              <tr>
                <th class="sortable" data-key="name">ì´ë¦„</th>
                <th class="sortable" data-key="phone">ì—°ë½ì²˜</th>
                <th class="sortable" data-key="age">ë‚˜ì´</th>
                <th class="sortable" data-key="gender">ì„±ë³„</th>
                <th>ì£¼ìš” ë‚´ì› ëª©ì </th>
                <th class="sortable" data-key="pain_level">í†µì¦ ê°•ë„</th>
                <th class="sortable" data-key="createdAt">ì‘ì„± ë‚ ì§œ</th>
                <th>íƒœê·¸</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="muted" id="no-data" style="padding:8px; display:none;">
            ì•„ì§ ë¬¸ì§„ ë°ì´í„°ê°€ ì—†ê±°ë‚˜, í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
          <div class="pagination" id="pagination">
            <button class="page-btn" type="button" onclick="changePage('prev')">ì´ì „</button>
            <span class="page-info" id="page-info">í˜ì´ì§€ 1 / 1</span>
            <button class="page-btn" type="button" onclick="changePage('next')">ë‹¤ìŒ</button>
          </div>
        </div>

        <!-- ê·¸ë˜í”„ -->
        <div class="graph-card">
          <div class="graph-title">ğŸ“Š í†µì¦ ì–‘ìƒ ë¶„í¬</div>
          <div class="graph-subtitle">
            index.html ë¬¸ì§„ì—ì„œ ì„ íƒëœ í†µì¦ ì–‘ìƒ(pain_type) ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
          </div>
          <div class="graph-wrapper">
            <canvas id="symptomChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ì•„ë˜ ë²„íŠ¼ -->
      <div class="footer-actions">
        <button class="btn btn-outline" type="button" onclick="exportCSV()">
          â¬‡ CSVë¡œ ë‚´ë³´ë‚´ê¸°
        </button>
        <button class="btn btn-primary" type="button" onclick="syncAllToGoogleSheets()">
          ğŸ”„ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì²´ ë™ê¸°í™”
        </button>
        <button class="btn btn-outline btn-sm" type="button" onclick="openSettingsModal()">
          âš™ ê³ ê¸‰ ì˜µì…˜
        </button>
      </div>
    </section>

    <!-- ì¤‘ë³µ ë‚´ì›ì ìš”ì•½ -->
    <section class="card dup-card">
      <div class="card-title">ğŸ‘¥ ì¤‘ë³µ ë‚´ì›ì ìš”ì•½ (ì´ë¦„ + ì—°ë½ì²˜ ê¸°ì¤€)</div>
      <div class="card-subtitle">
        ê°™ì€ ì´ë¦„ê³¼ ì—°ë½ì²˜ë¡œ 2íšŒ ì´ìƒ ë¬¸ì§„í•œ íšŒì›ë“¤ì„ ëª¨ì•„ ë³´ì—¬ì¤ë‹ˆë‹¤. ì¬ë“±ë¡/ì¥ê¸° ì¼€ì´ìŠ¤ ê´€ë¦¬ì— í™œìš©í•´ ë³´ì„¸ìš”.
      </div>
      <div class="table-container" style="border:none; box-shadow:none;">
        <table id="duplicate-table">
          <thead>
            <tr>
              <th>ì´ë¦„</th>
              <th>ì—°ë½ì²˜</th>
              <th>ë¬¸ì§„ íšŸìˆ˜</th>
              <th>ë§ˆì§€ë§‰ ë¬¸ì§„ì¼</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="muted" id="no-duplicate" style="padding:8px; display:none;">
          ì•„ì§ ì¤‘ë³µ ë‚´ì›ìë¡œ ë¶„ë¥˜ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    </section>

    <!-- ë™ì˜ì„œ í˜„í™© ì¹´ë“œ -->
    <section class="card">
      <div class="card-title">ğŸ“„ ë™ì˜ì„œ í˜„í™©</div>
      <div class="card-subtitle">
        ê° ë¬¸ì§„ì— ì—°ê²°ëœ ë™ì˜ì„œ ì •ë³´ë¥¼ í•¨ê»˜ ì €ì¥í•´ ë‘” ë‚´ìš©ì…ë‹ˆë‹¤.<br />
        ëˆ„ê°€ ê°œì¸ì •ë³´Â·ì˜ìƒÂ·AI í™œìš©ì— ë™ì˜í–ˆëŠ”ì§€ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
      <div class="table-container" style="border:none; box-shadow:none;">
        <table id="consent-table">
          <thead>
            <tr>
              <th>ì´ë¦„ (ë¬¸ì§„)</th>
              <th>ì—°ë½ì²˜</th>
              <th>ë™ì˜ì„œ ì´ë¦„(ì„œëª…)</th>
              <th>ë™ì˜ì„œ ì‘ì„±ì¼</th>
              <th>ê°œì¸ì •ë³´</th>
              <th>ì˜ìƒÂ·ì‚¬ì§„</th>
              <th>AI/ì—°êµ¬</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="muted" id="no-consent" style="padding:8px; display:none;">
          ì•„ì§ ë™ì˜ì„œê°€ ë¬¸ì§„ê³¼ í•¨ê»˜ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    </section>
  </div>

  <!-- ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="detail-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="detail-title">ìƒì„¸ ë¬¸ì§„ ë‚´ìš©</div>
          <div class="modal-meta" id="detail-meta">-</div>
        </div>
        <button class="modal-close" type="button" onclick="closeDetail()">âœ•</button>
      </div>

      <div id="detail-body"></div>

      <div class="modal-note">
        ì´ í™”ë©´ì€ ìƒë‹´ ì‹œ ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ì¤‘ìš”í•œ íšŒì›ì˜ ê²½ìš°, ë‚´ìš©ì„ ì—‘ì…€/ë…¸ì…˜ì— ë³µì‚¬í•˜ê³ 
        <strong>íƒœê·¸ ê¸°ëŠ¥</strong>ìœ¼ë¡œ ì¬ë“±ë¡/ê´€ë¦¬ ìš°ì„ ìˆœìœ„ë¥¼ í‘œì‹œí•´ë‘ë©´ ì¢‹ì•„ìš”.
      </div>
    </div>
  </div>

  <script>
    // ====== ì„¤ì • ======
    const ADMIN_PASSWORD = "godmade2024!"; // â˜… ì›í•˜ëŠ” ê¸°ë³¸ ë¹„ë²ˆ
    const GOOGLE_SHEETS_WEBAPP_URL =
      "https://script.google.com/macros/s/AKfycbynHi_DfiJhDe6BD9o5hVlz9VKsEuCzQO9AcJKIpn-2hiItqStvTbxOkaA9ICdT6UlTCA/exec"; // â˜… ì›¹ì•± URL
    const PAGE_SIZE = 15;

    let allData = [];
    let filteredData = [];
    let currentSortKey = null;
    let currentSortDir = "asc";
    let symptomChart = null;
    let currentPage = 1;
    let currentDetailEntry = null;

    const tableBody = document.querySelector("#data-table tbody");
    const searchInput = document.getElementById("search-input");
    const dateFromInput = document.getElementById("date-from");
    const dateToInput = document.getElementById("date-to");
    const noDataEl = document.getElementById("no-data");
    const paginationEl = document.getElementById("pagination");
    const pageInfoEl = document.getElementById("page-info");

    const loginBackdrop = document.getElementById("login-backdrop");
    const passwordInput = document.getElementById("admin-password-input");
    const rememberCheckbox = document.getElementById("remember-login");
    const pwBackdrop = document.getElementById("pw-backdrop");
    const settingsBackdrop = document.getElementById("settings-backdrop");

    // ====== ë¹„ë°€ë²ˆí˜¸ / ë¡œê·¸ì¸ ======
    function getCurrentPassword() {
      return localStorage.getItem("gm_admin_password") || ADMIN_PASSWORD;
    }

    function attemptLogin() {
      const val = passwordInput.value;
      if (!val) {
        alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (val !== getCurrentPassword()) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      if (rememberCheckbox.checked) {
        localStorage.setItem("gm_admin_logged_in", "true");
      }
      loginBackdrop.style.display = "none";
      initDashboard();
    }

    passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") attemptLogin();
    });

    function openPwModal() {
      pwBackdrop.classList.add("active");
      document.getElementById("pw-current").value = "";
      document.getElementById("pw-new").value = "";
      document.getElementById("pw-confirm").value = "";
    }

    function closePwModal() {
      pwBackdrop.classList.remove("active");
    }

    pwBackdrop.addEventListener("click", (e) => {
      if (e.target === pwBackdrop) closePwModal();
    });

    function changePassword() {
      const current = document.getElementById("pw-current").value;
      const newPw = document.getElementById("pw-new").value;
      const confirmPw = document.getElementById("pw-confirm").value;

      if (current !== getCurrentPassword()) {
        alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      if (!newPw) {
        alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (newPw !== confirmPw) {
        alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      localStorage.setItem("gm_admin_password", newPw);
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¡œê·¸ì¸ë¶€í„° ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
      closePwModal();
    }

    // ê³ ê¸‰ ì˜µì…˜ ëª¨ë‹¬
    function openSettingsModal() {
      settingsBackdrop.classList.add("active");
    }

    function closeSettingsModal() {
      settingsBackdrop.classList.remove("active");
    }

    settingsBackdrop.addEventListener("click", (e) => {
      if (e.target === settingsBackdrop) closeSettingsModal();
    });

    // ì‚­ì œë¥¼ í•œ ë²ˆ ë” ê°ì‹¼ í•¨ìˆ˜
    function handleClearData() {
      const ok = confirm(
        "ì •ë§ë¡œ ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ëª¨ë“  ë¬¸ì§„/ë™ì˜ì„œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      );
      if (!ok) return;
      clearData();
      closeSettingsModal();
    }

    // í˜ì´ì§€ ì—´ë¦´ ë•Œ ìë™ ë¡œê·¸ì¸ ì²´í¬
    (function checkLogin() {
      const remembered = localStorage.getItem("gm_admin_logged_in") === "true";
      if (remembered) {
        loginBackdrop.style.display = "none";
        initDashboard();
      } else {
        loginBackdrop.style.display = "flex";
      }
    })();

    function initDashboard() {
      loadData();
    }

    // ====== ë°ì´í„° ë¡œë“œ / í†µê³„ ======
    function loadData() {
      const raw = localStorage.getItem("gm_posture_submissions");
      allData = raw ? JSON.parse(raw) : [];

      // ìµœì‹  ìˆœ ì •ë ¬
      allData.sort((a, b) => {
        const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
        const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
        return tb - ta;
      });

      filteredData = [...allData];
      currentPage = 1;

      updateStats();
      updateChart();
      renderTable();
      updateDuplicates();
      updateConsentTable();
    }

    function saveAllData() {
      localStorage.setItem("gm_posture_submissions", JSON.stringify(allData));
    }

    function updateStats() {
      const totalEl = document.getElementById("stat-total");
      const lastEl = document.getElementById("stat-last");
      const painEl = document.getElementById("stat-pain");
      const painExtraEl = document.getElementById("stat-pain-extra");
      const purposeEl = document.getElementById("stat-purpose");
      const purposeExtraEl = document.getElementById("stat-purpose-extra");

      const total = allData.length;
      totalEl.textContent = total;

      if (!total) {
        lastEl.textContent = "ìµœê·¼ ì‘ì„±: -";
        painEl.textContent = "0.0";
        painExtraEl.textContent = "ë°ì´í„° ì—†ìŒ";
        purposeEl.textContent = "-";
        purposeExtraEl.textContent = "";
        return;
      }

      const last = allData[0];
      const created = last.createdAt ? new Date(last.createdAt) : null;
      if (created && !isNaN(created)) {
        const d = `${created.getFullYear()}-${String(
          created.getMonth() + 1
        ).padStart(2, "0")}-${String(created.getDate()).padStart(2, "0")}`;
        lastEl.textContent = "ìµœê·¼ ì‘ì„±: " + d;
      } else {
        lastEl.textContent = "ìµœê·¼ ì‘ì„±: -";
      }

      let sum = 0;
      let cnt = 0;
      allData.forEach((d) => {
        const n = Number(d.pain_level || d["pain_level"]);
        if (!isNaN(n)) {
          sum += n;
          cnt++;
        }
      });
      if (cnt === 0) {
        painEl.textContent = "0.0";
        painExtraEl.textContent = "í†µì¦ ê°•ë„ ì…ë ¥ ë°ì´í„° ì—†ìŒ";
      } else {
        const avg = (sum / cnt).toFixed(1);
        painEl.textContent = avg;
        const v = Number(avg);
        let txt = "";
        if (v <= 3) txt = "ì „ë°˜ì ìœ¼ë¡œ ê²½ë¯¸í•œ í†µì¦ ì¼€ì´ìŠ¤ê°€ ë§ìŠµë‹ˆë‹¤.";
        else if (v <= 6) txt = "ì¤‘ê°„ ì •ë„ì˜ í†µì¦ ì¼€ì´ìŠ¤ ë¹„ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤.";
        else txt = "ê³ ê°•ë„ í†µì¦ìœ¼ë¡œ ë‚´ì›í•˜ëŠ” íšŒì›ì´ ë§ì€ í¸ì…ë‹ˆë‹¤.";
        painExtraEl.textContent = txt;
      }

      const purposeCount = {};
      allData.forEach((d) => {
        const arr = d.purposes || d.purpose || [];
        const list = Array.isArray(arr) ? arr : [arr];
        list.forEach((p) => {
          const key = String(p || "").trim();
          if (!key) return;
          purposeCount[key] = (purposeCount[key] || 0) + 1;
        });
      });

      let topPurpose = "-";
      let maxCnt = 0;
      Object.entries(purposeCount).forEach(([k, c]) => {
        if (c > maxCnt) {
          maxCnt = c;
          topPurpose = k;
        }
      });

      purposeEl.textContent = topPurpose;
      purposeExtraEl.textContent = topPurpose === "-" ? "" : `ì´ ${maxCnt}ëª…ì´ ì„ íƒ`;
    }

    // ====== í•„í„° / ê²€ìƒ‰ ======
    function applyFilters() {
      const keyword = searchInput.value.trim().toLowerCase();
      const fromStr = dateFromInput.value;
      const toStr = dateToInput.value;

      const fromTime = fromStr ? new Date(fromStr + "T00:00:00").getTime() : null;
      const toTime = toStr ? new Date(toStr + "T23:59:59").getTime() : null;

      filteredData = allData.filter((d) => {
        const json = JSON.stringify(d).toLowerCase();
        if (keyword && !json.includes(keyword)) return false;

        if (fromTime || toTime) {
          const t = d.createdAt ? new Date(d.createdAt).getTime() : null;
          if (!t) return false;
          if (fromTime && t < fromTime) return false;
          if (toTime && t > toTime) return false;
        }

        return true;
      });

      currentPage = 1;
      if (currentSortKey) sortData(currentSortKey, currentSortDir);
      renderTable();
    }

    function resetFilters() {
      searchInput.value = "";
      dateFromInput.value = "";
      dateToInput.value = "";
      filteredData = [...allData];
      currentPage = 1;
      if (currentSortKey) sortData(currentSortKey, currentSortDir);
      renderTable();
    }

    searchInput.addEventListener("input", applyFilters);
    dateFromInput.addEventListener("change", applyFilters);
    dateToInput.addEventListener("change", applyFilters);

    // ====== ì •ë ¬ / í˜ì´ì§€ë„¤ì´ì…˜ / í…Œì´ë¸” ë Œë” ======
    function sortData(key, dir) {
      filteredData.sort((a, b) => {
        let va = a[key];
        let vb = b[key];

        if (key === "createdAt") {
          va = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          vb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
        }

        if (key === "age" || key === "pain_level") {
          va = Number(va || 0);
          vb = Number(vb || 0);
        }

        if (typeof va === "string") va = va.toLowerCase();
        if (typeof vb === "string") vb = vb.toLowerCase();

        if (va < vb) return dir === "asc" ? -1 : 1;
        if (va > vb) return dir === "asc" ? 1 : -1;
        return 0;
      });
    }

    function changePage(direction) {
      const totalPages = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
      if (direction === "prev") {
        if (currentPage > 1) currentPage--;
      } else if (direction === "next") {
        if (currentPage < totalPages) currentPage++;
      } else if (typeof direction === "number") {
        if (direction >= 1 && direction <= totalPages) currentPage = direction;
      }
      renderTable();
    }

    function renderPagination(totalPages) {
      if (!paginationEl) return;
      if (totalPages <= 1 || filteredData.length === 0) {
        paginationEl.style.display = "none";
        return;
      }
      paginationEl.style.display = "flex";
      pageInfoEl.textContent = `í˜ì´ì§€ ${currentPage} / ${totalPages}`;
    }

    function renderTable() {
      tableBody.innerHTML = "";

      if (!filteredData.length) {
        noDataEl.style.display = "block";
        renderPagination(1);
        return;
      }
      noDataEl.style.display = "none";

      const totalPages = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = filteredData.slice(start, start + PAGE_SIZE);

      pageItems.forEach((d) => {
        const tr = document.createElement("tr");
        tr.addEventListener("click", () => openDetail(d));

        const purposes = normalizeMulti(d.purposes || d.purpose);
        const mainPurpose = purposes[0] || "-";

        const created = d.createdAt ? new Date(d.createdAt) : null;
        const createdStr =
          created && !isNaN(created)
            ? `${created.getFullYear()}-${String(created.getMonth() + 1).padStart(
                2,
                "0"
              )}-${String(created.getDate()).padStart(2, "0")}`
            : "-";

        const tags = normalizeMulti(d.tags);

        tr.innerHTML = `
          <td>${escapeHtml(d.name || "-")}</td>
          <td>${escapeHtml(d.phone || "-")}</td>
          <td>${d.age || "-"}</td>
          <td>${d.gender || "-"}</td>
          <td>${
            mainPurpose !== "-"
              ? `<span class="pill">${escapeHtml(mainPurpose)}</span>`
              : "-"
          }</td>
          <td>${
            d.pain_level !== undefined && d.pain_level !== null
              ? d.pain_level + "/10"
              : "-"
          }</td>
          <td>${createdStr}</td>
          <td>${
            tags.length
              ? `<span class="pill pill-tag">${escapeHtml(tags[0])}${
                  tags.length > 1 ? ` ì™¸ ${tags.length - 1}` : ""
                }</span>`
              : "-"
          }</td>
        `;

        tableBody.appendChild(tr);
      });

      renderPagination(totalPages);
    }

    document.querySelectorAll("th.sortable").forEach((th) => {
      th.addEventListener("click", (e) => {
        e.stopPropagation();
        const key = th.dataset.key;
        if (!key) return;
        if (currentSortKey === key) {
          currentSortDir = currentSortDir === "asc" ? "desc" : "asc";
        } else {
          currentSortKey = key;
          currentSortDir = "asc";
        }
        sortData(currentSortKey, currentSortDir);
        currentPage = 1;
        renderTable();
      });
    });

    // ====== ìƒì„¸ ëª¨ë‹¬ + íƒœê·¸ ======
    const backdrop = document.getElementById("detail-backdrop");
    const detailTitleEl = document.getElementById("detail-title");
    const detailMetaEl = document.getElementById("detail-meta");
    const detailBodyEl = document.getElementById("detail-body");

    function openDetail(d) {
      currentDetailEntry = d;
      if (!currentDetailEntry.tags) currentDetailEntry.tags = [];

      detailTitleEl.textContent = d.name ? `${d.name}ë‹˜ ë¬¸ì§„ ìƒì„¸` : "ë¬¸ì§„ ìƒì„¸";

      const created = d.createdAt ? new Date(d.createdAt) : null;
      const createdStr =
        created && !isNaN(created)
          ? `${created.getFullYear()}-${String(created.getMonth() + 1).padStart(
              2,
              "0"
            )}-${String(created.getDate()).padStart(2, "0")} ${String(
              created.getHours()
            ).padStart(2, "0")}:${String(created.getMinutes()).padStart(2, "0")}`
          : "-";

      detailMetaEl.textContent = `${d.phone || "-"} Â· ì‘ì„±ì¼ ${createdStr}`;

      const purposes = normalizeMulti(d.purposes || d.purpose);
      const painTypes = normalizeMulti(d.pain_types || d.pain_type);
      const postures = normalizeMulti(d.postures || d.posture);
      const skeleton = normalizeMulti(d.skeleton_issues || d.skeleton);
      const goals = normalizeMulti(d.goals || d.goal);

      detailBodyEl.innerHTML = `
        <div class="modal-section">
          <div class="modal-section-title">â­ ì¼€ì´ìŠ¤ íƒœê·¸</div>
          <div class="modal-row" id="tag-list-row"></div>
          <div class="modal-row" style="margin-top:4px; display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
            <input id="tag-input" type="text" placeholder="ì˜ˆ: ì¬ë“±ë¡ìœ ë ¥, ì¶”ê°€ê²€ì‚¬í•„ìš” ë“±" class="login-input" style="margin-bottom:0; max-width:220px; padding:6px 8px; font-size:0.78rem;" />
            <button type="button" class="btn btn-outline btn-sm" onclick="addTagFromInput()">íƒœê·¸ ì¶”ê°€</button>
          </div>
          <div class="modal-note">
            ìƒë‹´ ì¤‘ ë– ì˜¤ë¥¸ ë©”ëª¨ë¥¼ ê°„ë‹¨íˆ íƒœê·¸ë¡œ ë‚¨ê²¨ë‘ë©´, ë‚˜ì¤‘ì— ì¬ë‚´ì›/ê´€ë¦¬ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 1. ê¸°ë³¸ ì •ë³´</div>
          <div class="modal-row">
            <span class="modal-label">ì´ë¦„ / ì„±ë³„ / ë‚˜ì´</span><br/>
            ${escapeHtml(d.name || "-")} / ${d.gender || "-"} / ${
        d.age ? d.age + "ì„¸" : "-"
      }
          </div>
          <div class="modal-row">
            <span class="modal-label">ì—°ë½ì²˜</span><br/>
            ${escapeHtml(d.phone || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ë‚´ì›ì¼(ì˜ˆì•½ ì˜ˆì •ì¼)</span><br/>
            ${escapeHtml(d.visit_date || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ì§ì—…</span><br/>
            ${escapeHtml(d.job || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ì£¼ ì‚¬ìš© ì†</span><br/>
            ${escapeHtml(d.hand || "-")}
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 2. ë‚´ì› ëª©ì </div>
          <div class="modal-row">
            ${renderChips(purposes) || "-"}
          </div>
          <div class="modal-row">
            <span class="modal-label">ê¸°íƒ€</span><br/>
            ${escapeHtml(d.purpose_etc || "-")}
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 3. í†µì¦ ê´€ë ¨ ë¬¸ì§„</div>
          <div class="modal-row">
            <span class="modal-label">í†µì¦ ë¶€ìœ„</span><br/>
            ${escapeHtml(d.pain_area || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">í†µì¦ ê°•ë„</span><br/>
            ${
              d.pain_level !== undefined && d.pain_level !== null
                ? d.pain_level + "/10"
                : "-"
            }
          </div>
          <div class="modal-row">
            <span class="modal-label">í†µì¦ ì–‘ìƒ</span><br/>
            ${renderChips(painTypes) || "-"}
          </div>
          <div class="modal-row">
            <span class="modal-label">í†µì¦ ì–‘ìƒ ê¸°íƒ€</span><br/>
            ${escapeHtml(d.pain_type_etc || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">í†µì¦ ë°œìƒ ì‹œê¸°</span><br/>
            ${escapeHtml(d.pain_onset || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">í•˜ë£¨ ì¤‘ ê°€ì¥ ì•„í”ˆ ì‹œê°„ëŒ€</span><br/>
            ${escapeHtml(d.pain_time || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ì•…í™”ë˜ëŠ” ìƒí™©</span><br/>
            ${escapeHtml(d.pain_worse || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ì™„í™”ë˜ëŠ” ìƒí™©</span><br/>
            ${escapeHtml(d.pain_better || "-")}
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 4. ìƒí™œÂ·ìì„¸ íŒ¨í„´</div>
          <div class="modal-row">
            <span class="modal-label">í•˜ë£¨ í‰ê·  ì•‰ì•„ ìˆëŠ” ì‹œê°„</span><br/>
            ${escapeHtml(d.sitting || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ì£¼ëœ ìì„¸</span><br/>
            ${renderChips(postures) || "-"}
          </div>
          <div class="modal-row">
            <span class="modal-label">ì£¼ëœ ìì„¸ ê¸°íƒ€</span><br/>
            ${escapeHtml(d.posture_etc || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ìˆ˜ë©´ ì‹œê°„</span><br/>
            ${d.sleep_hours ? d.sleep_hours + "ì‹œê°„" : "-"}
          </div>
          <div class="modal-row">
            <span class="modal-label">ìˆ˜ë©´ ì‹œ ë¶ˆí¸í•¨</span><br/>
            ${escapeHtml(d.sleep_discomfort || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€</span><br/>
            ${escapeHtml(d.stress || "-")}
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 5. ìš´ë™/í™œë™ ìˆ˜ì¤€</div>
          <div class="modal-row">
            <span class="modal-label">í˜„ì¬ ìš´ë™ ì—¬ë¶€</span><br/>
            ${escapeHtml(d.exercise_now || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ìš´ë™ ë¹ˆë„</span><br/>
            ${d.exercise_freq ? d.exercise_freq + "íšŒ/ì£¼" : "-"}
          </div>
          <div class="modal-row">
            <span class="modal-label">ìš´ë™ ì¢…ë¥˜</span><br/>
            ${escapeHtml(d.exercise_type || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ì´ì „ ë¶€ìƒ/ìˆ˜ìˆ  ê²½í—˜</span><br/>
            ${escapeHtml(d.injury || "-")}
          </div>
          <div class="modal-row">
            <span class="modal-label">ë¶€ìœ„/ì‹œê¸°</span><br/>
            ${escapeHtml(d.injury_detail || "-")}
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 6. ê³¨ê²©Â·ì²´í˜• ìê°€ ì§„ë‹¨</div>
          <div class="modal-row">
            ${renderChips(skeleton) || "-"}
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 7. ëª©í‘œ ì„¤ì •</div>
          <div class="modal-row">
            <span class="modal-label">ì£¼ìš” ëª©í‘œ</span><br/>
            ${renderChips(goals) || "-"}
          </div>
          <div class="modal-row">
            <span class="modal-label">ê¸°íƒ€ ëª©í‘œ</span><br/>
            ${escapeHtml(d.goal_etc || "-")}
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">ğŸ“Œ 8. ê¸°íƒ€ ì°¸ê³  ì‚¬í•­</div>
          <div class="modal-row">
            ${escapeHtml(d.notes || "-")}
          </div>
        </div>
      `;

      renderTagList();
      backdrop.classList.add("active");
    }

    function renderTagList() {
      const container = document.getElementById("tag-list-row");
      if (!container || !currentDetailEntry) return;
      const tags = normalizeMulti(currentDetailEntry.tags);
      if (!tags.length) {
        container.innerHTML = `<span class="modal-label">ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ì…ë ¥ì°½ì—ì„œ íƒœê·¸ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”.</span>`;
        return;
      }
      container.innerHTML = tags
        .map(
          (tag, idx) => `
          <span class="pill pill-tag">
            ${escapeHtml(tag)}
            <button type="button" class="tag-remove" onclick="removeTag(${idx}); event.stopPropagation();">Ã—</button>
          </span>
        `
        )
        .join("");
    }

    function addTagFromInput() {
      if (!currentDetailEntry) return;
      const input = document.getElementById("tag-input");
      if (!input) return;
      const value = input.value.trim();
      if (!value) return;

      if (!currentDetailEntry.tags) currentDetailEntry.tags = [];
      if (!currentDetailEntry.tags.includes(value)) {
        currentDetailEntry.tags.push(value);
        saveAllData();
        renderTagList();
        renderTable();
        updateDuplicates();
        updateConsentTable();
      }
      input.value = "";
    }

    function removeTag(index) {
      if (!currentDetailEntry || !currentDetailEntry.tags) return;
      currentDetailEntry.tags.splice(index, 1);
      saveAllData();
      renderTagList();
      renderTable();
      updateDuplicates();
      updateConsentTable();
    }

    function closeDetail() {
      backdrop.classList.remove("active");
      currentDetailEntry = null;
    }

    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) closeDetail();
    });

    // ====== GRAPH ======>
    function updateChart() {
      const ctx = document.getElementById("symptomChart").getContext("2d");

      const counts = {};
      allData.forEach((d) => {
        const list = normalizeMulti(d.pain_types || d.pain_type);
        list.forEach((t) => {
          const key = t.trim();
          if (!key) return;
          counts[key] = (counts[key] || 0) + 1;
        });
      });

      const labels = Object.keys(counts);
      const values = Object.values(counts);

      if (symptomChart) symptomChart.destroy();

      symptomChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "ì„ íƒ íšŸìˆ˜",
              data: values,
              backgroundColor: "#bfdbfe",
              borderColor: "#2563eb",
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    // ====== ì¤‘ë³µ ë‚´ì›ì ìš”ì•½ ======>
    function updateDuplicates() {
      const tbody = document.querySelector("#duplicate-table tbody");
      const noDup = document.getElementById("no-duplicate");
      tbody.innerHTML = "";

      if (!allData.length) {
        noDup.style.display = "block";
        return;
      }

      const map = {};
      allData.forEach((d) => {
        const name = (d.name || "").trim();
        const phone = (d.phone || "").trim();
        if (!name || !phone) return;
        const key = name.toLowerCase() + "|" + phone;
        const created = d.createdAt ? new Date(d.createdAt).getTime() : 0;
        if (!map[key]) {
          map[key] = { name, phone, count: 0, last: 0 };
        }
        map[key].count += 1;
        if (created > map[key].last) map[key].last = created;
      });

      const duplicates = Object.values(map).filter((v) => v.count >= 2);
      if (!duplicates.length) {
        noDup.style.display = "block";
        return;
      }
      noDup.style.display = "none";

      duplicates.sort((a, b) => b.last - a.last);

      duplicates.forEach((item) => {
        const tr = document.createElement("tr");
        const lastDate = item.last
          ? (() => {
              const d = new Date(item.last);
              return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
                2,
                "0"
              )}-${String(d.getDate()).padStart(2, "0")}`;
            })()
          : "-";

        tr.innerHTML = `
          <td>${escapeHtml(item.name)}</td>
          <td>${escapeHtml(item.phone)}</td>
          <td>${item.count}</td>
          <td>${lastDate}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== ë™ì˜ì„œ í…Œì´ë¸” ======>
    function updateConsentTable() {
      const tbody = document.querySelector("#consent-table tbody");
      const noConsent = document.getElementById("no-consent");
      tbody.innerHTML = "";

      const rows = allData.filter((d) => d.consent);
      if (!rows.length) {
        noConsent.style.display = "block";
        return;
      }
      noConsent.style.display = "none";

      rows.forEach((d) => {
        const c = d.consent || {};
        const consentName = c.consent_name || "-";
        const consentDate = c.consent_date || "-";
        const personal = c.agree_personal ? "ë™ì˜" : "ë¯¸ë™ì˜";
        const media = c.agree_media ? "ë™ì˜" : "ë¯¸ë™ì˜";
        const ai = c.agree_ai ? "ë™ì˜" : "ë¯¸ë™ì˜";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(d.name || "-")}</td>
          <td>${escapeHtml(d.phone || "-")}</td>
          <td>${escapeHtml(consentName)}</td>
          <td>${escapeHtml(consentDate || "-")}</td>
          <td>${personal}</td>
          <td>${media}</td>
          <td>${ai}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== CSV EXPORT ======>
    function exportCSV() {
      if (!allData.length) {
        alert("ë‚´ë³´ë‚¼ ë¬¸ì§„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const headers = [
        "name",
        "phone",
        "age",
        "gender",
        "visit_date",
        "job",
        "hand",
        "purposes",
        "purpose_etc",
        "pain_area",
        "pain_level",
        "pain_types",
        "pain_type_etc",
        "pain_onset",
        "pain_time",
        "pain_worse",
        "pain_better",
        "sitting",
        "postures",
        "posture_etc",
        "sleep_hours",
        "sleep_discomfort",
        "stress",
        "exercise_now",
        "exercise_freq",
        "exercise_type",
        "injury",
        "injury_detail",
        "skeleton_issues",
        "goals",
        "goal_etc",
        "notes",
        "tags",
        "consent_name",
        "consent_date",
        "agree_personal",
        "agree_media",
        "agree_ai",
        "createdAt"
      ];

      const rows = allData.map((d) => {
        return headers
          .map((h) => {
            let v = "";

            if (h === "consent_name") {
              v = d.consent && d.consent.consent_name ? d.consent.consent_name : "";
            } else if (h === "consent_date") {
              v = d.consent && d.consent.consent_date ? d.consent.consent_date : "";
            } else if (h === "agree_personal") {
              v = d.consent && d.consent.agree_personal ? "ë™ì˜" : "ë¯¸ë™ì˜";
            } else if (h === "agree_media") {
              v = d.consent && d.consent.agree_media ? "ë™ì˜" : "ë¯¸ë™ì˜";
            } else if (h === "agree_ai") {
              v = d.consent && d.consent.agree_ai ? "ë™ì˜" : "ë¯¸ë™ì˜";
            } else {
              v = d[h];
              if (Array.isArray(v)) v = v.join(" / ");
              if (v === undefined || v === null) v = "";
            }

            v = String(v).replace(/"/g, '""');
            return `"${v}"`;
          })
          .join(",");
      });

      const csv = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "godmade_intake_export.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ====== GOOGLE SHEETS SYNC (ì „ì²´ ë™ê¸°í™”) ======>
    async function syncAllToGoogleSheets() {
      if (!GOOGLE_SHEETS_WEBAPP_URL) {
        alert("ë¨¼ì € admin.html ìƒë‹¨ì˜ GOOGLE_SHEETS_WEBAPP_URL ê°’ì„ ì±„ì›Œì£¼ì„¸ìš”.");
        return;
      }
      if (!allData.length) {
        alert("ë™ê¸°í™”í•  ë¬¸ì§„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const ok = confirm(
        "í˜„ì¬ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ëª¨ë“  ë¬¸ì§„ ë°ì´í„°ë¥¼ êµ¬ê¸€ ì‹œíŠ¸ì™€ ë™ê¸°í™”í• ê¹Œìš”?\n" +
        "â€» ì´ë¯¸ ì „ì†¡ëœ ë°ì´í„°ê°€ ë‹¤ì‹œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìœ¼ë‹ˆ, ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œ ì—¬ëŸ¬ ë²ˆ ë™ê¸°í™”í•  ë• ì£¼ì˜í•´ì£¼ì„¸ìš”."
      );
      if (!ok) return;

      try {
        await fetch(GOOGLE_SHEETS_WEBAPP_URL, {
          method: "POST",
          mode: "no-cors", // ì‘ë‹µì€ ì•ˆ ì½ê³  ì¡°ìš©íˆ ìš”ì²­ë§Œ ë³´ëƒ„
          headers: {
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify({ entries: allData })
        });

        alert(
          "êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë™ê¸°í™” ìš”ì²­ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.\n" +
          "ëª‡ ì´ˆ ë’¤ êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ [ì›ë³¸ë°ì´í„°] íƒ­ì„ ìƒˆë¡œê³ ì¹¨í•´ì„œ ì‹¤ì œë¡œ í–‰ì´ ì¶”ê°€ëëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”."
        );
      } catch (e) {
        console.error("êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", e);
        alert(
          "ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ìš”ì²­ì„ ë³´ë‚´ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n" +
          "ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
        );
      }
    }

    // ====== UTIL ======>
    function normalizeMulti(value) {
      if (!value) return [];
      if (Array.isArray(value)) return value;
      return [value];
    }

    function renderChips(list) {
      if (!list || !list.length) return "";
      return list
        .filter((x) => String(x).trim() !== "")
        .map((x) => `<span class="pill">${escapeHtml(x)}</span>`)
        .join("");
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function clearData() {
      localStorage.removeItem("gm_posture_submissions");
      allData = [];
      filteredData = [];
      currentPage = 1;
      updateStats();
      updateChart();
      renderTable();
      updateDuplicates();
      updateConsentTable();
    }
  </script>
</body>
</html>
